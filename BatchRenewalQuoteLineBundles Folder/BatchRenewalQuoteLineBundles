global class BatchRenewalQuoteLineBundles implements 
Database.Batchable<SObject>, Database.Stateful {
    
    List<SBQQ__QuoteLine__c> bundleQuoteLines;
    Integer daysBeforeRenew;
    Map<Id, List<SBQQ__ProductOption__c>> productIdOptionMap = new Map<Id, List<SBQQ__ProductOption__c>>();
    
    // 1. Query for Product Options related to each suite bundle
    global BatchRenewalQuoteLineBundles(List<SBQQ__QuoteLine__c> bundleQuoteLines, Integer daysBeforeRenew){
        this.bundleQuoteLines = bundleQuoteLines;
        this.daysBeforeRenew = daysBeforeRenew;
		List<SBQQ__ProductOption__c> productOptionList = [Select Id,SBQQ__ConfiguredSKU__c, SBQQ__OptionalSKU__c, SBQQ__Discount__c
             FROM SBQQ__ProductOption__c WHERE SBQQ__ConfiguredSKU__r.Name LIKE '%Suite%'];  
        
        for (SBQQ__ProductOption__c productOption : productOptionList){   
            
            Id configuredSkuId = productOption.SBQQ__ConfiguredSKU__c;
            
            List<SBQQ__ProductOption__c> productList = this.productIdOptionMap.containsKey(configuredSkuId) ? this.productIdOptionMap.get(configuredSkuId) : new List<SBQQ__ProductOption__c>();
            
            productList.add(productOption);
            
            this.productIdOptionMap.put(configuredSkuId, productList);
            
            
        }
        
    }
    global List<SBQQ__QuoteLine__c> start(Database.BatchableContext bc) {
        return bundleQuoteLines;
        
    }
    
    // 2. For each quote line passed into the batch, add a component quoteline for each option.
    global void execute(Database.BatchableContext bc, List<SBQQ__QuoteLine__c> scope){
        
        
        // look at extra bits of info in component quote line
        
        List<SBQQ__QuoteLine__c> quoteLineList = new List<SBQQ__QuoteLine__c>();
        
        //for quoteLine in the list of Bundle quotes - suite core + suite 24/7
        for (SBQQ__QuoteLine__c bundleQuoteLine : scope){    
            
            //essentially configured SKU on Product Option
            Id bundleProductId = bundleQuoteline.SBQQ__Product__c;
            
            //bundle quote line id
            Id bundleQuoteLineId = bundleQuoteLine.Id;
            
            // get list of product options from product Id option map. Iterate through  each product option and adding a quote line for each one
            for (SBQQ__ProductOption__c po : productIdOptionMap.get(bundleProductId)){       
  
                
            SBQQ__QuoteLine__c quoteLine = new SBQQ__QuoteLine__c();
            
            quoteLine.SBQQ__RequiredBy__c = bundleQuoteLineId;
            quoteLine.SBQQ__ProductOption__c = po.Id;
            quoteLine.SBQQ__Product__c = po.SBQQ__OptionalSKU__c;
            quoteLine.SBQQ__OptionDiscount__c = po.SBQQ__Discount__c;
            quoteLine.SBQQ__StartDate__c = bundleQuoteLine.SBQQ__StartDate__c;
            quoteLine.SBQQ__EndDate__c = bundleQuoteLine.SBQQ__EndDate__c;
            quoteLine.Sales_Discount__c = bundleQuoteLine.Sales_Discount__c;
            quoteLine.SBQQ__Quote__c = bundleQuoteLine.SBQQ__Quote__c;
            quoteLine.Deal_Type__c = 'Renewal';
                
            quoteLineList.add(quoteLine);   
                
            }
            
              
            
        }
        
		insert quoteLineList;
        
    }
    
    
    global void finish(Database.BatchableContext bc){
        
        
    }
    
}

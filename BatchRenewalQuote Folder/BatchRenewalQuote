// 1. Create a new class that implements batch apex called BatchRenewalQuote
global class BatchRenewalQuote implements 
Database.Batchable<SObject>, Database.Stateful {
    
    Set<Id> quoteIds = new Set<Id>();
    
    // 2. Declare as a class variable a list of Ids called oppIds
    List<Id> oppIds = new List<Id>();
    Integer daysBeforeRenew;
    Map<Id,SBQQ__Quote__c> oppIdQuoteMap = new Map<Id,SBQQ__Quote__c>();
    
    // 3. Create a constructor to set the value of oppIds when an instance of the BatchRenewalQuote is created 
    global BatchRenewalQuote(List<Id> oppIds, Integer daysBeforeRenew){
        this.oppIds = oppIds;
        this.daysBeforeRenew = daysBeforeRenew;
        
    }
    
    // 4. Within the start method, query for the opportunities that have the Ids from oppIds 
    global Database.QueryLocator start(Database.BatchableContext bc) {
        
        return Database.getQueryLocator(
            [SELECT Id, QuotePrimaryPartner__c, PrimaryDistributor__c,
             Partner_Rep__c, AccountId, Channel__c, SBQQ__PrimaryQuote__r.Price_List__c, QuotePrimaryPartner__r.Price_List_Formula__c
             FROM Opportunity WHERE Id IN :oppIds AND isClosed = False]
            
        );
        
        
        
        
    }   
    global void execute(Database.BatchableContext bc, List<Opportunity> scope){
        
        system.debug(scope);
        
        List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
        
        Map<Id,Opportunity> oppMap = new Map<Id,Opportunity>(scope);
        
        
        try{
            SBQQ.TriggerControl.disable();
            
            // 6. Within the execute method, instantiate an empty list of SBQQ__Quote__c. This is the list of quotes that we are going to insert at the end of the transaction.
            
            
            // 7. Create a for loop. For each opportunity in your scope, create a new quote setting the following values
            for (Opportunity opp : scope){
                SBQQ__Quote__c quote = new SBQQ__Quote__c();
                
                quote.SBQQ__Primary__c = True;
                quote.SBQQ__Opportunity2__c = opp.id;
                quote.SBQQ__Status__c = 'Draft';
                quote.SBQQ__Account__c = opp.AccountId;
                quote.SBQQ__Type__c = 'Renewal';
                quote.Created_by_csmRenewalFlow__c  = TRUE;
                
                if (opp.Channel__c == 'Direct'){
                    quote.Price_List__c = 'Direct';
                }
                
                if (opp.Channel__c == 'Indirect'){
                    quote.SBQQ__Partner__c = opp.QuotePrimaryPartner__c;
                    quote.SBQQ__Distributor__c = opp.PrimaryDistributor__c;
                    quote.Partner_Rep__c = opp.Partner_Rep__c;
                    quote.Price_List__c = opp.QuotePrimaryPartner__r.Price_List_Formula__c;
                    
                    
                }
                
                
                
                system.debug('quote.Partner_Rep__c: '+ opp.QuotePrimaryPartner__c);
                
                system.debug('quote.SBQQ__Partner__c: '+ quote.Partner_Rep__c);
                
                system.debug('opp.Channe: '+ opp.Channel__c);
                
                system.debug('quote.SBQQ__Type__c: '+ quote.SBQQ__Type__c);
                
                system.debug('quote.SBQQ__Status__c' + quote.SBQQ__Status__c);
                
                
                // 8. Add to the quote list
                quoteList.add(quote);
            }
            
            // 9. After a quote has been created for each opp, insert the list          
            insert quoteList;
            
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            
            List<Opportunity> primaryQuoteOpps = new List<Opportunity>();
            
            for(SBQQ__Quote__c qte : quoteList){
                Opportunity opp = oppMap.get(qte.SBQQ__Opportunity2__c);
                opp.SBQQ__PrimaryQuote__c = qte.Id;
                primaryQuoteOpps.add(opp);
                
            }
            
            update primaryQuoteOpps;
            
            
            
            
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            
            
            
            
            SBQQ.TriggerControl.enable();
            
            Map <ID, SBQQ__Quote__c> quoteIdList = new Map <ID, SBQQ__Quote__c>(quoteList);
            
            quoteIds.addAll(quoteIdList.keySet());
            
            
        }
        catch(Exception err){
            String errMsg = 'Error Message: '+err.getMessage();
            errMsg += '\nStack Trace: '+err.getStackTraceString();
            errMsg += '\nQuote List: '+quoteList;
            Error_Log_Handler.errorHandler('BatchRenewalQuote',errMsg);
        }
        
    }
    global void finish(Database.BatchableContext bc){
        
        system.debug('quoteIds: '+ quoteIds);
        
        
        BatchRenewalQuoteLine job = new BatchRenewalQuoteLine(quoteIds, daysBeforeRenew);
        Database.executeBatch(job, 1);
        
        //Database.executeBatch(new BatchRenewalQuoteLine(quoteIds, daysBeforeRenew));
        //Database.executeBatch(new BatchRenewalPrimaryQuotes(oppIdQuoteMap, daysBeforeRenew));
        
    }
    
}

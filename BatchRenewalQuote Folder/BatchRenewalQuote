// 1. Create a new class that implements batch apex called BatchRenewalQuote
global class BatchRenewalQuote implements 
Database.Batchable<SObject>, Database.Stateful {
    
    Set<Id> quoteIds = new Set<Id>();

    // 2. Declare as a class variable a list of Ids called oppIds
   	List<Id> oppIds = new List<Id>();
    Integer daysBeforeRenew;
    
    // 3. Create a constructor to set the value of oppIds when an instance of the BatchRenewalQuote is created 
	global BatchRenewalQuote(List<Id> oppIds, Integer daysBeforeRenew){
            this.oppIds = oppIds;
        	this.daysBeforeRenew = daysBeforeRenew;
        		
    }
          
   // 4. Within the start method, query for the opportunities that have the Ids from oppIds 
   global Database.QueryLocator start(Database.BatchableContext bc) {
        return Database.getQueryLocator(
            [SELECT Id, QuotePrimaryPartner__c, PrimaryDistributor__c,
             Partner_Rep__c, AccountId, Channel__c
             FROM Opportunity WHERE Id IN :oppIds]
            
        );
   
   }   
   global void execute(Database.BatchableContext bc, List<Opportunity> scope){
       
       // 6. Within the execute method, instantiate an empty list of SBQQ__Quote__c. This is the list of quotes that we are going to insert at the end of the transaction.
       List<SBQQ__Quote__c> quoteList = new List<SBQQ__Quote__c>();
       
       // 7. Create a for loop. For each opportunity in your scope, create a new quote setting the following values
       for (Opportunity opp : scope){
           SBQQ__Quote__c quote = new SBQQ__Quote__c();
           
           quote.SBQQ__Primary__c = True;
           quote.SBQQ__Opportunity2__c = opp.id;
           quote.SBQQ__Status__c = 'Draft';
           quote.SBQQ__Account__c = opp.AccountId;
           
           if (opp.Channel__c == 'Direct'){
               quote.Price_List__c = 'Direct';
           }
           
           if (opp.Channel__c == 'Indirect'){
               quote.SBQQ__Partner__c = opp.QuotePrimaryPartner__c;
               quote.SBQQ__Distributor__c = opp.PrimaryDistributor__c;
               quote.Partner_Rep__c = opp.Partner_Rep__c;
           }
           
    	    // 8. Add to the quote list
      		quoteList.add(quote);
       }
       
      // 9. After a quote has been created for each opp, insert the list          
      insert quoteList;
       
      //pull out IDs to be inserted in batch renewal quote line

      Map <ID, SBQQ__Quote__c> quoteIdList = new Map <ID, SBQQ__Quote__c>(quoteList);
       
      quoteIds = quoteIdList.keySet();
      
     
           
       
   }
   global void finish(Database.BatchableContext bc){
       
       Database.executeBatch(new BatchRenewalQuoteLine(quoteIds, daysBeforeRenew));
       
       
       
       
   }
       
}

